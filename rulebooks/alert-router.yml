---
- name: route-alerts-by-alertname
  hosts: localhost
  sources:
    - ansible.eda.webhook: {}

  rules:
    - name: handle HighCPU
      condition: event.payload.alert.labels.alertname == "HighCPU"
      action:
        run_job_template:
          name: "Remediate-CPU"
          organization: "Default"
          job_args:
            extra_vars:
              alertname: "{{ event.payload.alert.labels.alertname | default('N/A') }}"
              instance:  "{{ event.payload.alert.labels.instance   | default('N/A') }}"
              severity:  "{{ event.payload.alert.labels.severity   | default('N/A') }}"
              target_hosts: "{{ event.payload.alert.labels.host | default('localhost') }}"

    - name: handle DiskFull
      condition: event.payload.alert.labels.alertname == "DiskFull"
      action:
        run_job_template:
          name: "Remediate-Disk"
          organization: "Default"
          job_args:
            extra_vars:
              alertname: "{{ event.payload.alert.labels.alertname | default('N/A') }}"
              instance:  "{{ event.payload.alert.labels.instance   | default('N/A') }}"
              severity:  "{{ event.payload.alert.labels.severity   | default('N/A') }}"
              target_hosts: "{{ event.payload.alert.labels.host | default('localhost') }}"

    # 兜底（可保留你之前的 1==1，或更保险地判定 payload 存在）
    - name: catch-all for unknown alerts
      condition: event.payload is defined
      action:
        debug:
          msg: >
            Unknown alert: {{ event.payload.alert.labels.alertname | default('N/A') }}
            Full payload: {{ event.payload | to_json }}


